name: Deploy VuePress Site

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/deploy-docs.yml'

  pull_request:
    paths:
      - 'docs/**'

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      # 这里改成在 docs 目录里执行 npm ci
      - name: Install Dependencies (docs package)
        working-directory: ./docs
        run: npm i

      # 同样在 docs 目录里执行构建命令
      - name: Build VuePress
        working-directory: ./docs
        run: npm run build

      # ------------------------------------------------------------
      # 使用 rsync --delete：最佳实践（不会中间断造成空站）
      # ------------------------------------------------------------

      - name: Deploy to HK (Main Origin)
        if: github.event_name == 'push'
        uses:  burnett01/rsync-deployments@7.1.0
        with:
          switches: -az --delete
          path: docs/.vuepress/dist/
          remote_path: /home/gmkit-site/www/
          remote_user: ${{ secrets.USER }}
          remote_host: ${{ secrets.HK_HOST }}
          remote_key:  ${{ secrets.SSH_KEY }}

      - name: Deploy to CN (Mirror Origin)
        if: github.event_name == 'push'
        uses:  burnett01/rsync-deployments@7.1.0
        with:
          switches: -az --delete
          path: docs/.vuepress/dist/
          remote_path: /home/gmkit-site/www/
          remote_user: ${{ secrets.USER }}
          remote_host: ${{ secrets.CN_HOST }}
          remote_key:  ${{ secrets.SSH_KEY }}

      # ------------------------------------------------------------
      # EdgeOne CDN 缓存刷新 (支持国内站和国际站)
      # ------------------------------------------------------------
      - name: Purge EdgeOne CDN Cache (Domestic - CN)
        if: github.event_name == 'push'
        uses: 2061360308/edgeone-purge-action@main
        with:
          secret_id: ${{ secrets.TENCENT_SECRET_ID }}
          secret_key: ${{ secrets.TENCENT_SECRET_KEY }}
          zone_id: ${{ secrets.EDGEONE_ZONE_ID_CN }}
          purge_type: 'purge_url'
          targets: |
            https://gmkit.cn/
          flush_type: 'purge_all'

      - name: Purge EdgeOne CDN Cache (International - Global)
        if: github.event_name == 'push'
        uses: 2061360308/edgeone-purge-action@main
        with:
          secret_id: ${{ secrets.TENCENT_SECRET_ID }}
          secret_key: ${{ secrets.TENCENT_SECRET_KEY }}
          zone_id: ${{ secrets.EDGEONE_ZONE_ID_GLOBAL }}
          purge_type: 'purge_url'
          targets: |
            https://gmkit.com/
          flush_type: 'purge_all'
