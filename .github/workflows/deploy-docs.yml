name: Deploy VuePress Site

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/deploy-docs.yml'

  pull_request:
    paths:
      - 'docs/**'

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      # 这里改成在 docs 目录里执行 npm ci
      - name: Install Dependencies (docs package)
        working-directory: ./docs
        run: npm i

      # 同样在 docs 目录里执行构建命令
      - name: Build VuePress
        working-directory: ./docs
        run: npm run build

      # ------------------------------------------------------------
      # 使用 rsync --delete：最佳实践（不会中间断造成空站）
      # ------------------------------------------------------------

      - name: Deploy to HK (Main Origin)
        if: github.event_name == 'push'
        uses:  burnett01/rsync-deployments@7.1.0
        with:
          switches: -az --delete
          path: docs/.vuepress/dist/
          remote_path: /home/gmkit-site/www/
          remote_user: ${{ secrets.USER }}
          remote_host: ${{ secrets.HK_HOST }}
          remote_password: ${{ secrets.HK_PASS }}

      - name: Deploy to CN (Mirror Origin)
        if: github.event_name == 'push'
        uses:  burnett01/rsync-deployments@7.1.0
        with:
          switches: -az --delete
          path: docs/.vuepress/dist/
          remote_path: /home/gmkit-site/www/
          remote_user: ${{ secrets.USER }}
          remote_host: ${{ secrets.CN_HOST }}
          remote_password: ${{ secrets.CN_PASS }}

#      - name: Purge EdgeOne CDN Cache
#        if: github.event_name == 'push'
#        run: |
#          echo "Purging cache..."
#          curl -X POST "https://api.edgeone.com/purge?zone=${{ secrets.EDGE_ZONE }}" \
#            -H "Authorization: Bearer ${{ secrets.EDGE_TOKEN }}" \
#            --fail || echo "Purge failed or API not supported"
