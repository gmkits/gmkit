name: Deploy VuePress Site

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/deploy-docs.yml'

  pull_request:
    paths:
      - 'docs/**'

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      # 这里改成在 docs 目录里执行 npm ci
      - name: Install Dependencies (docs package)
        working-directory: ./docs
        run: npm i

      # 同样在 docs 目录里执行构建命令
      - name: Build VuePress
        working-directory: ./docs
        run: npm run build

      # ------------------------------------------------------------
      # 使用 rsync --delete：最佳实践（不会中间断造成空站）
      # ------------------------------------------------------------

      - name: Deploy to HK (Main Origin)
        if: github.event_name == 'push'
        uses:  burnett01/rsync-deployments@7.1.0
        with:
          switches: -az --delete
          path: docs/.vuepress/dist/
          remote_path: /home/gmkit-site/www/
          remote_user: ${{ secrets.USER }}
          remote_host: ${{ secrets.HK_HOST }}
          remote_key:  ${{ secrets.SSH_KEY }}

      - name: Deploy to CN (Mirror Origin)
        if: github.event_name == 'push'
        uses:  burnett01/rsync-deployments@7.1.0
        with:
          switches: -az --delete
          path: docs/.vuepress/dist/
          remote_path: /home/gmkit-site/www/
          remote_user: ${{ secrets.USER }}
          remote_host: ${{ secrets.CN_HOST }}
          remote_key:  ${{ secrets.SSH_KEY }}

      # ------------------------------------------------------------
      # EdgeOne CDN 缓存刷新 (支持国内站和国际站)
      # 使用自定义 Python 脚本支持不同的 API 端点
      # 国内站: teo.tencentcloudapi.com
      # 国际站: teo.intl.tencentcloudapi.com
      # 支持多个域名刷新（逗号分隔）
      # 速率限制：通过 GitHub API 检查上次成功运行时间
      # ------------------------------------------------------------
      - name: Purge EdgeOne CDN Cache (Domestic - CN)
        if: github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MIN_INTERVAL_HOURS: 1
        run: |
          python3 .github/scripts/purge_edgeone.py \
            "${{ secrets.TENCENT_SECRET_ID_CN }}" \
            "${{ secrets.TENCENT_SECRET_KEY_CN }}" \
            "${{ secrets.EDGEONE_ZONE_ID_CN }}" \
            "gmkit.cn" \
            --site-type=cn

      - name: Purge EdgeOne CDN Cache (International - Global)
        if: github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MIN_INTERVAL_HOURS: 1
        run: |
          python3 .github/scripts/purge_edgeone.py \
            "${{ secrets.TENCENT_SECRET_ID_GLOBAL }}" \
            "${{ secrets.TENCENT_SECRET_KEY_GLOBAL }}" \
            "${{ secrets.EDGEONE_ZONE_ID_GLOBAL }}" \
            "gmkit.com" \
            --site-type=intl
