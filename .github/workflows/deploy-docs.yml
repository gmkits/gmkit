name: Deploy VuePress Site

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/deploy-docs.yml'

  pull_request:
    paths:
      - 'docs/**'

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      # 这里改成在 docs 目录里执行 npm ci
      - name: Install Dependencies (docs package)
        working-directory: ./docs
        run: npm i

      # 同样在 docs 目录里执行构建命令
      - name: Build VuePress
        working-directory: ./docs
        run: npm run build

      # ------------------------------------------------------------
      # 使用 rsync --delete：最佳实践（不会中间断造成空站）
      # ------------------------------------------------------------

      - name: Deploy to HK (Main Origin)
        if: github.event_name == 'push'
        uses:  burnett01/rsync-deployments@7.1.0
        with:
          switches: -az --delete
          path: docs/.vuepress/dist/
          remote_path: /home/gmkit-site/www/
          remote_user: ${{ secrets.USER }}
          remote_host: ${{ secrets.HK_HOST }}
          remote_key:  ${{ secrets.SSH_KEY }}

      - name: Deploy to CN (Mirror Origin)
        if: github.event_name == 'push'
        uses:  burnett01/rsync-deployments@7.1.0
        with:
          switches: -az --delete
          path: docs/.vuepress/dist/
          remote_path: /home/gmkit-site/www/
          remote_user: ${{ secrets.USER }}
          remote_host: ${{ secrets.CN_HOST }}
          remote_key:  ${{ secrets.SSH_KEY }}

      # ------------------------------------------------------------
      # EdgeOne CDN 缓存刷新 (支持国内站和国际站)
      # 使用 Tencent Cloud CLI 以支持不同区域的端点
      # ------------------------------------------------------------
      - name: Setup Tencent Cloud CLI
        if: github.event_name == 'push'
        run: |
          pip install --upgrade pip
          pip install tccli

      - name: Configure Tencent Cloud CLI
        if: github.event_name == 'push'
        run: |
          tccli configure set secretId ${{ secrets.TENCENT_SECRET_ID }}
          tccli configure set secretKey ${{ secrets.TENCENT_SECRET_KEY }}
          tccli configure set region ap-guangzhou

      - name: Purge EdgeOne CDN Cache (Domestic - CN)
        if: github.event_name == 'push'
        run: |
          tccli teo CreatePurgeTask \
            --ZoneId ${{ secrets.EDGEONE_ZONE_ID_CN }} \
            --Type purge_host \
            --Targets '["gmkit.cn"]' \
            --region ap-guangzhou

      - name: Purge EdgeOne CDN Cache (International - Global)
        if: github.event_name == 'push'
        run: |
          tccli teo CreatePurgeTask \
            --ZoneId ${{ secrets.EDGEONE_ZONE_ID_GLOBAL }} \
            --Type purge_host \
            --Targets '["gmkit.com"]' \
            --endpoint teo.ap-singapore.tencentcloudapi.com
